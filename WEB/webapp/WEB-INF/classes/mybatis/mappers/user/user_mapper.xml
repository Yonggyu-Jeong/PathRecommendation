<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mybatis.shadow.user.user_mapper">

	<!-- 유저 목록 조회 MyBatis -->
	<select id="selectUserListSQL"
		resultType="common.collection.ABox"
		parameterType="common.collection.ABox">
	<![CDATA[
		SELECT 
			* 
		FROM 
			member
		WHERE 
			id = #{id} AND
			password = #{password}
	]]>
	</select>

	<select id="selectLocationLabelCountSQL"
		resultType="common.collection.ABox"
		parameterType="common.collection.ABox">
	<![CDATA[
		SELECT 
			COUNT(*)  
		FROM 
			locate

	]]>
	</select>

	<insert id="insertLocationSQL"
		parameterType="common.collection.ABox">
		<![CDATA[
			INSERT INTO locate
				( name,
				category,
				city,
				area,
				road,
				info,	
				lng,
				lat )
			VALUES ( 
				#{BIZEST_NM},
				#{category},
				#{SIGUN_NM},
				#{REFINE_ROADNM_ADDR},
				#{REFINE_LOTNO_ADDR},
				#{BIZCOND_NM},
				#{REFINE_WGS84_LOGT},
				#{REFINE_WGS84_LAT} )
		]]>
	</insert>

	<insert id="insertReviewSQL"
		parameterType="common.collection.ABox">
		<![CDATA[
			INSERT INTO review_maps
				(
				locate_seq
				review,
				star,
				category )
			VALUES ( 
				#{locateSeq},
				#{review},
				#{star},
				#{category} )
		]]>
	</insert>

	<insert id="insertLocationLabelSQL"
		parameterType="common.collection.ABox">
		<![CDATA[
			INSERT INTO locate_label
				( locate_seq,
				door_tag,
				tag1,
				tag2,
				tag3,
				tag4 )
			VALUES ( 
				#{locateSeq},
				#{doorTag},
				#{tag1},
				#{tag2},
				#{tag3},
				#{tag4} )
		]]>
	</insert>
	<select id="selectLocateList"
		resultType="common.collection.ABox"
		parameterType="common.collection.ABox">
		<![CDATA[
		SELECT 
			a.*, b.* 
		FROM 
			locate a, locate_label b
		WHERE 
			a.locate_id = b.label_seq AND
			lng < #{maxLng} AND lat < #{maxLat} AND lng > #{minLng} AND lat > #{minLat}
		]]>
	</select>

	<!-- 유저 목록 조회 MyBatis -->
	<select id="selectLocateDataSQL"
		resultType="common.collection.ABox"
		parameterType="common.collection.ABox">
	<![CDATA[
		SELECT 
			AVG(a.star) AS star, b.*
		FROM 
			review_maps a, locate_label b
		WHERE 
	]]>
		a.locate_seq IN
		<foreach collection="locateIdList" item="location" index="idx"
			open='(' close=')' separator=','>
			#{location.location}
		</foreach>
		AND a.locate_seq = b.locate_seq
		group BY a.star;

	</select>

	<select id="selectLocateList2"
		resultType="common.collection.ABox"
		parameterType="common.collection.ABox">
	<![CDATA[
		SELECT 
			a.locate_id, b.label_seq, a.name, a.category, a.road, a.lng, a.lat, b.rate, b.tag1, b.tag2, b.tag3, b.tag4, b.door_tag, b.rate
		FROM 
			locate a, locate_label b
		WHERE
			a.locate_id IN
	]]>
		<foreach collection="locateIdList" item="location" index="idx"
			open='(' close=')' separator=','>
			#{location.location}
		</foreach>
		AND a.locate_id = b.label_seq
	</select>

	<select id="selectCategoryListSQL"
		resultType="common.collection.ABox"
		parameterType="common.collection.ABox">
	<![CDATA[
		SELECT 
			a.locate_id, a.name, a.category, a.city, a.area, a.road, a.info, a.lng, a.lat, b.rate, b.tag1, b.tag2, b.tag3, b.tag4
		FROM 
			locate a, locate_label b
		WHERE 
	]]>
		<if test="category != '' and category != null">
			a.category = #{category} AND
		</if>
			b.locate_seq = a.locate_id AND (a.city = "시흥시" OR a.city = "안산시")
		ORDER BY 
			b.rate
		DESC
		LIMIT 
			0, 7;
	</select>
	
		<select id="selectCategoryListCS99SQL"
		resultType="common.collection.ABox"
		parameterType="common.collection.ABox">
	<![CDATA[
		SELECT 
			a.locate_id, a.name, a.category, a.city, a.area, a.road, a.info, a.lng, a.lat, b.rate, b.tag1, b.tag2, b.tag3, b.tag4
		FROM 
			locate a, locate_label b
		WHERE 
			b.locate_seq = a.locate_id AND (a.city = "시흥시" OR a.city = "안산시")
			AND a.category != "CS01"
		ORDER BY 
			b.rate
		DESC
		LIMIT 
			0, 7;
	]]>
	</select>
	
	
	
	<select id="selectCategoryListCS08SQL"
		resultType="common.collection.ABox"
		parameterType="common.collection.ABox">
	<![CDATA[
		SELECT 
			a.locate_id, a.name, a.category, a.city, a.area, a.road, a.info, a.lng, a.lat, b.rate, b.tag1, b.tag2, b.tag3, b.tag4
		FROM 
			locate a, locate_label b
		WHERE 
			a.category = #{category} AND
			b.locate_seq = a.locate_id
		ORDER BY 
			b.rate
		DESC
		LIMIT 
			0, 7;
	]]>
	</select>
	
	
	<select id="selectCategoryUserListSQL"
		resultType="common.collection.ABox"
		parameterType="common.collection.ABox">
	<![CDATA[
		SELECT 
			a.locate_id, a.name, a.category, a.city, a.area, a.road, a.info, a.lng, a.lat, d.rate, d.tag1, d.tag2, d.tag3, d.tag4
		FROM 
			locate a, member b, member_path c, locate_label d
		WHERE 
			b.id = #{name} AND c.choose = #{option} AND
			c.member_id = b.member_seq AND
			a.locate_id = c.locate_id AND
			d.locate_seq = a.locate_id 
		ORDER BY
			d.rate
		DESC 
		LIMIT 
			0, 7;
	]]>
	</select>
	
	<update id="updateRate" parameterType="common.collection.ABox">
	<![CDATA[
		UPDATE locate_label
		SET rate = 1.5+ROUND(RAND()*3.5,1)
		WHERE label_seq = #{idx};
	]]>
	</update>

	<insert id="insertUserLocationSQL"
		parameterType="common.collection.ABox">
		<![CDATA[
			INSERT INTO member_path
				( member_id,
				locate_id,
				star,
				mapId,
				choose
				)
			VALUES ( 
				#{member_id},
				#{locate_id},
				#{star},
				#{mapId},
				#{choose}
				)
		]]>
	</insert>
	
	<select id="selectMapMemberPathSQL"
		resultType="common.collection.ABox"
		parameterType="common.collection.ABox">
	<![CDATA[
		SELECT 
			COUNT(*) AS cnt
		FROM
			member_path a, locate b
		WHERE 
			b.name = #{name} AND
			b.locate_id = a.locate_id AND
			a.member_id = 1
	]]>
	</select>
	
	
	<select id="selectMapInfoSQL"
		resultType="common.collection.ABox"
		parameterType="common.collection.ABox">
	<![CDATA[
	
		SELECT 
			a.locate_id, a.name, a.category, a.city, a.area, a.road, a.info, a.lng, a.lat, b.rate, b.tag1, b.tag2, b.tag3, b.tag4
		FROM 
			locate a, locate_label b
		WHERE 
			a.name = #{name} AND
			b.locate_seq = a.locate_id
	]]>
	</select>
	
</mapper>